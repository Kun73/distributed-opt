# A sharp estimate of the transient time of DSGD

In this chapter, we derive an estimate of transient time $K_T$ of DSGD and then show it is sharp[@pu2019sharp]. During this, we will prove lemma \@ref(lem:riskdsgd) in chapter \@ref(sec:asynt). 

Still, we set $f_i, i\in\mathcal{N}$ are $\mu-$strongly convex with $L-$Lipschitz continuous gradients, the graph $\mathcal{G}=(\mathcal{N},\mathcal{E})$ is connected and undirected, and we are able to obtain "good" gradient estimates $g_i(x_i(k),\xi_i(k))$, i.e. the assumptions \@ref(exr:muL), \@ref(exr:estg), \@ref(exr:dsgtgraph),and \@ref(exr:dsw) hold. 

We first derive the recursion of $R'(k),U(k),$ and $V(k)$ defined in chapter \@ref(sec:asynt).

## $U(k)$ and $V(k)$

To keep the consistency in notation, we still use $h(X)=\frac{1}{n}\mathbf{1}^T\nabla F(X)$, which the authors denote as $\bar\nabla F(X)$. Let $\bar g(k)=\frac{1}{n}\mathbf{1}^TG(X(k),\boldsymbol\xi(k))$^[In chapter \@ref(sec:asynt), $\bar g(k)=\frac{1}{n}\sum\limits_{i=1}^n g_i(x(k),\xi_i(k))$ ]. The idea is the same as that in \@ref(eq:xbar1dsgt), we have 
\begin{align}
\bar x(k+1)-x^*&=\bar x(k)-\alpha_k\left[\bar g(k)-\frac{1}{n}\mathbf{1}^T\nabla F(X(k))\right]-\\
&\alpha_k\left[\frac{1}{n}\mathbf{1}^T\nabla F(X(k))-\nabla f(\bar x(k))\right]-\alpha_k\nabla f(\bar x(k))-x^*\\
&:=(\bar x(k)-\alpha_k\nabla f(\bar x(k))-x^*)-\alpha_k(\bar g(k)-h(X(k)))-\\
&\alpha_k(h(X(k))-\nabla f(\bar x(k)))
(#eq:dsgdxbar1)
\end{align}

Then we can use lemma \@ref(lem:lem2) and assumption \@ref(exr:estg). Moreover, we use $|\langle a,b\rangle|\leq \Vert a\Vert \cdot\Vert b\Vert$ to deal with $<\bar x(k)-\alpha_k\nabla f(\bar x(k))-x^*,\nabla f(\bar x(k))-h(X(k))>$. Then take expectation conditioned on $X(k)$, we have lemma \@ref(lem:condxbardsgd). 


```{lemma, condxbardsgd}
For algorithm \@ref(exm:dsgd), $\forall k\geq0$, we have, 
\begin{align}
&E\left[\left\|\bar{x}(k+1)-x^{*}\right\|^{2} | X(k)\right] \leq\left\|\bar{x}(k)-\alpha_{k} \nabla f(\bar{x}(k))-x^{*}\right\|^{2}\\
&+\frac{2 \alpha_{k} L}{\sqrt{n}}\left\|\bar{x}(k)-\alpha_{k} \nabla f(\bar{x}(k))-x^{*}\right\|\|X(k)-\mathbf{1} \bar{x}(k)\|+\frac{\alpha_{k}^{2} L^{2}}{n}\|X(k)-\mathbf{1} \bar{x}(k)\|^{2}+\frac{\alpha_{k}^{2} \sigma^{2}}{n}
\end{align}
```

From lemma \@ref(lem:condxbardsgd), let $\alpha_k=\frac{1}{\mu k}<\frac{2}{\mu+L}$, use lemma \@ref(lem:lem31), and take full expectation on both sides, we derive lemma \@ref(lem:riskdsgd) in chapter \@ref(sec:asynt). 
\begin{align}
U(k+1)&\leq (1-\frac{1}{k})^2 U(k)+\frac{2L(1-\frac{1}{k})}{\mu k\sqrt{n}}E\left[\Vert \bar x(k)-x^*\Vert\cdot \Vert x(k)-\mathbf{1}\bar x(k)\Vert\right]+\\
&\frac{L^2}{\mu^2 k^2n}V(k)+\frac{\sigma^2}{\mu^2k^2n}\\
&\leq (1-\frac{1}{k})^2 U(k)+\frac{2L}{\mu\sqrt{n}}\frac{\sqrt{U(k)V(k)}}{k}+\frac{L^2}{\mu^2 k^2n}V(k)+\frac{\sigma^2}{\mu^2k^2n}
\end{align}
Where We use Cauchy-Schwartz inequality in the second inequality.

We can also separate $\frac{2 \alpha_{k} L}{\sqrt{n}}\left\|\bar{x}(k)-\alpha_{k} \nabla f(\bar{x}(k))-x^{*}\right\|\|X(k)-\mathbf{1} \bar{x}(k)\|$ by 
\begin{align}
&\frac{2 \alpha_{k} L}{\sqrt{n}}\left\|\bar{x}(k)-\alpha_{k} \nabla f(\bar{x}(k))-x^{*}\right\|\|X(k)-\mathbf{1} \bar{x}(k)\|\\
&\leq \lambda^2c\Vert \bar x(k)-x^*\Vert + \frac{L^2}{cn}\Vert X(k)-\mathbf{1}\bar x(k)\Vert
(\#eq:sepc)
\end{align}
for an arbitary $c>0$(in chapter \@ref(sec:dsgt), we let $c=\mu$). $\lambda$ comes from lemma \@ref(lem:contraction2L). Comparing lemma \@ref(lem:contraction2L) with lemma \@ref(lem:lem31), they only differ with the choice of $\alpha$. 

```{lemma, contraction2L}
Let assumption \@ref(exr:muL) holds, $\forall x\in\mathbb{R}^p$ and $\alpha\in(0,2/L)$, we have, 
$$
  \left\|x-\alpha \nabla f(x)-x^{*}\right\| \leq \lambda\left\|x-x^{*}\right\|
$$
where $\lambda=\max (|1-\alpha \mu|,|1-\alpha L|)$
```

From lemma \@ref(lem:condxbardsgd) and \@ref(eq:sepc), take the full expectation on both sides, we have for $\alpha_k\in(0,2/L)$, 

\begin{align}
U(k+1)\leq \lambda^2(1+c) U(k)+\frac{\alpha_k^2L^2}{cn}(1+\frac{1}{c})V(k)+\frac{\alpha_k\sigma^2}{n}
(\#eq:Uk1)
\end{align}

For $V(k+1)$, similar to \@ref(eq:ineq2dsgt), we denote $G(k):=G(X(k),\boldsymbol\xi(k))$ here, then for $\forall c>0$, 
\begin{align}
\Vert X(k+1)-\mathbf{1}\bar x(k+1)\Vert^2&=
\Vert WX(k)-\alpha_kWG(k)-\mathbf{1}(\bar x(k)-\alpha_k\bar g(k))\Vert^2\\
&\leq \rho_w^2\Vert X(k)-\mathbf{1}\bar x(k)\Vert^2+\alpha_k^2\rho_w^2\Vert G(k)-\mathbf{1}\bar g(k)\Vert^2 -\\
&2\alpha_k\langle WX(k)-\mathbf{1}\bar x(k),G(k)-\mathbf{1}\bar g(k)\rangle\\
&\leq \rho_w^2 \Vert X(k)-\mathbf{1}\bar x(k)\Vert^2+\alpha_k^2\rho_w^2 \Vert G(k)-\mathbf{1}\bar g(k)\Vert^2+\\
&\rho_w^2\left[c\Vert X(k)-\mathbf{1}\bar x(k)\Vert^2+\frac{1}{c}\Vert G(k)-\mathbf{1}\bar g(k)\Vert^2\right]
(\#eq:xbar1dsgd)
\end{align}

Next, we show 
\begin{align}
E\left[\Vert G(k)-\mathbf{1}\bar g(k)\Vert^2|X(k)\right]
&\leq\|\nabla F(X(k))-\mathbf{1} h(X(k))\|^{2}+n \sigma^{2}\\
\|\nabla F(X(k))-\mathbf{1} h(X(k))\|^{2}&\leq \Vert \nabla F(X(k))\Vert^2
(\#eq:xbar1dsgdl1)
\end{align}

This is because, 
\begin{align}
&E\left[\Vert G(k)-\mathbf{1}\bar g(k)\Vert^2|X(k)\right]\\
&=E\left[\Vert (G(k)-\nabla F(X(k)))-\mathbf{1}(\bar g(k)-h(X(k)))+(\nabla F(X(k))-\mathbf{1}h(X(k)))\Vert^2|X(k)\right]\\
&\leq E\left[\Vert G(k)-\nabla F(X(k)\Vert^2|X(k)\right]-nE\left[\Vert \bar g(k)-h(X(k)) \Vert^2|X(k)\right] + \\
&\quad\Vert \nabla F(X(k))-\mathbf{1}h(X(k))\Vert^2\\
&\leq n \sigma^{2}+ \|\nabla F(X(k))-\mathbf{1} h(X(k))\|^{2}\\
&\leq n\sigma^2 + \vert \nabla F(X(k))\Vert^2 +n\vert h(x)\Vert^2 \\
&\quad-2\langle\vert\nabla F(X(k)),\mathbf{1}h(X(k))\rangle \\
&\leq n\sigma^2 + \Vert \nabla F(X(k))\Vert^2 
\end{align}

The last inequality is from $\langle\mathbf{A}, \mathbf{B}\rangle:=\sum_{i=1}^{n}\left\langle A_{i}, B_{i}\right\rangle$,i.e. 
\begin{align}
\langle\nabla F(X(k)),\mathbf{1}h(X(k))\rangle&=\sum_{i=1}^n\langle\nabla f_i(x_i(k)),\frac{1}{n}\sum_{j=1}^n\nabla f_j(x_j(k))\rangle\\
&=n\langle \frac{1}{n}\sum_{i=1}^n \nabla f_i(x_i(k)),\frac{1}{n}\sum_{j=1}^n\nabla f_j(x_j(k))\rangle\\
&=n\Vert h(X(k))\Vert^2
\end{align}


Next, we bound $\vert \nabla F(X(k))\Vert^2$. Recall $\nabla f$ is $L-$Lipschitz continuous, and we need $X(k)-\mathbf{1}\bar x(k)$ as well as $\bar x(k)-x^*$, so we have,

\begin{align}
&\Vert \nabla F(X(k))\Vert^2\\
&= \Vert \nabla F(X(k))-\nabla F(\mathbf{1}\bar x(k))+\nabla F(\mathbf{1}\bar x(k))-\nabla F(\mathbf{1}x^*)+\nabla F(\mathbf{1}x^*)\Vert^2\\
&\leq\left(L\|X(k)-\mathbf{1} \bar{x}(k)\|+\sqrt{n} L\left\|\bar{x}(k)-x^{*}\right\|+\left\|\nabla F\left(\mathbf{1} x^{*}\right)\right\|\right)^{2}\\
&\stackrel{?}\leq 2 L^{2}\|X(k)-\mathbf{1} \bar{x}(k)\|^{2}+4 n L^{2}\left\|\bar{x}(k)-x^{*}\right\|^{2}+4\left\|\nabla F\left(\mathbf{1} x^{*}\right)\right\|^{2}
(#eq:xbar1dsgdl2)
\end{align}

Use the two inequalities \@ref(eq:xbar1dsgdl1) and \@ref(eq:xbar1dsgdl2) in \@ref(eq:xbar1dsgd), and let $c=\frac{1-\rho_w^2}{2}$ (the same choice of $c$ in \@ref(eq:ineq2dsgt) of chapter \@ref(sec:dsgt)), we have 

```{lemma, Vk1}
Under algorithm \@ref(exm:dsgd), $\forall k\geq0$, 
\begin{align}
V(k+1)&\leq \rho_{w}^{2}\left(\frac{3-\rho_{w}^{2}}{2}+2 \alpha_{k} \rho_{w}^{2} L+2 \alpha_{k}^{2} \rho_{w}^{2} L^{2}\right) V(k) + \\
& \rho_{w}^{2} \alpha_{k}^{2}\left[\frac{8 n L^{2}}{\left(1-\rho_{w}^{2}\right)} U(k)+\frac{8\left\|\nabla F\left(\mathbf{1} x^{*}\right)\right\|^{2}}{\left(1-\rho_{w}^{2}\right)}+n \sigma^{2}\right]
\end{align}
```

